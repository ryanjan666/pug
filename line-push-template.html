<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"><title>在 LIFF 傳送隱藏資料</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3"></script><script>window.dataLayer = window.dataLayer || []
function gtag () { dataLayer.push(arguments) } // eslint-disable-line
gtag('js', new Date())
gtag('config', 'UA-39556213-3')</script><script>(function () {
  const hostname = location.host.split(':')[0]
  if (hostname === 'localhost') document.write(`<script src="http://${hostname}:35729/livereload.js?snipver=1"></` + 'script>')
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-default@3/default.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.min.css"><style>[v-cloak] {
  display: none; }

.h-400px {
  height: 400px !important; }

#error {
  position: fixed;
  bottom: 0;
  z-index: 1071;
  left: 1rem;
  right: 1rem; }
  #error button.close {
    position: absolute;
    right: 1.25rem;
    top: .75rem; }
</style></head><body><div class="container text-monospace my-3" id="app" v-cloak v-show="ready"><div class="alert alert-danger" id="error" role="alert" v-show="error"><pre class="mb-0">{{ `${error}\n請於開發者工具中查看詳細錯誤內容` }}</pre><button class="close" type="button" @click="error = ''"><span>&times;</span></button></div><h1>LINE 訊息推送工具</h1><div class="form-group"><label for="csv">CSV 網址 (第一列會成為變數名稱)</label><textarea class="form-control form-control-sm" id="csv" v-model="i.csv"></textarea></div><div class="row"><div class="col"><div class="form-group"><label for="to">傳送給 (請使用變數)</label><input class="form-control form-control-sm" id="to" v-model="i.to"></div></div><div class="col"><div class="form-group"><label for="access-token">Access Token</label><input class="form-control form-control-sm" id="access-token" type="password" v-model="i.accessToken"></div></div></div><div class="form-group"><label for="msg">訊息內容 JSON (先處理變數才會轉 JSON，務必注意 JSON escape 的問題)</label><textarea class="form-control form-control-sm h-400px" id="msg" v-model="i.msg"></textarea></div><div class="row mx-n2"><button class="btn btn-light mx-2 my-1" disabled v-if="status">{{ status }}…</button><button class="btn btn-success mx-2 my-1" type="button" @click="linePush" v-else>推送訊息</button><a class="btn btn-outline-info mx-2 my-1" href="https://taichunmin.idv.tw/blog/2020-06-15-line-push-template.html" target="_blank">使用教學</a><a class="btn btn-outline-info mx-2 my-1" href="https://developers.line.biz/flex-simulator/" target="_blank">Flex 訊息模擬器</a><a class="btn btn-outline-info mx-2 my-1" href="https://developers.line.biz/en/reference/messaging-api/#flex-message" target="_blank">LINE 訊息文件</a><a class="btn btn-outline-info mx-2 my-1" href="https://lodash.com/docs/4.17.15#template" target="_blank">_.template 變數語法說明</a></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script><!-- bootstrap require jquery and pupper--><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script>const sleep = wait => new Promise(resolve => setTimeout(resolve, wait))

const vm = new Vue({ // eslint-disable-line
  el: '#app',
  data: {
    i: {
      accessToken: '',
      csv: '',
      msg: '',
      to: '${line_id}', // eslint-disable-line
    },
    error: '',
    ready: false,
    status: '',
  },
  async mounted () {
    try {
      const saved = JSON.parse(sessionStorage.getItem('line-push-template'))
      if (saved) this.$set(this, 'i', { ...this.i, ...saved })
    } catch (err) {}
    this.$watch('i', (newVal, oldVal) => {
      sessionStorage.setItem('line-push-template', JSON.stringify(this.i))
    }, { deep: true })
    this.ready = true
  },
  methods: {
    async linePush () {
      const errors = []
      try {
        // 取得 csv
        this.status = '正在從 csv 取得資料'
        const rows = await this.getCsv(this.i.csv)
        console.log(`成功從 csv 中取得 ${rows.length} 筆資料`)
        if (rows.length <= 0) throw new Error('csv 中沒有任何記錄')

        // 推送確認
        this.status = '等候使用者確認推送'
        await sleep(100)
        if (!confirm(`即將推送 ${rows.length} 則訊息！`)) throw new Error('使用者自行取消推送')

        // compile tpl
        this.status = '正在解析訊息內容 JSON'
        const tplTo = _.template(this.i.to)
        const tplMsg = _.template(this.i.msg)

        let sendCnt = 0
        for (const item of rows) {
          try {
            this.status = `正在傳送訊息 (${++sendCnt} / ${rows.length})`
            const to = tplTo({ ...item, _, Qs })
            const msg = JSON5.parse(tplMsg({ ...item, _, Qs }))
            await this.pushMessage(to, msg)
          } catch (err) {
            err.message = `第 ${sendCnt} 筆發生錯誤: ${err.message}`
            console.error(err)
            errors.push(err)
          }
        }
      } catch (err) {
        console.error(err)
        errors.push(err)
      }
      this.error = _.map(errors, err => err.message).join('\n')
      this.status = ''
    },
    async getCsv (url) {
      const csv = _.trim(_.get(await axios.get(url, {
        params: { cachebust: +new Date() },
      }), 'data'))
      return _.get(Papa.parse(csv, {
        encoding: 'utf8',
        header: true,
      }), 'data', [])
    },
    async pushMessage (to, messages, notificationDisabled = false) {
      try {
        if (!this.isLineId(to)) throw new Error(`不正確的 LINE userId: "${to}"`)
        if (!/^[A-Za-z0-9+/=]+$/.test(this.i.accessToken)) throw new Error(`不正確的 Access Token: "${this.i.accessToken}"`)
        if (_.includes(['bubble', 'carousel'], _.get(messages, 'type'))) {
          // 幫 Flex 訊息模擬器補上外層
          messages = {
            type: 'flex',
            altText: '您有一則新訊息',
            contents: messages,
          }
        }
        if (!_.isArray(messages)) messages = [messages]
        await axios.post('https://cors-anywhere.herokuapp.com/https://api.line.me/v2/bot/message/push', {
          to,
          messages,
          notificationDisabled,
        }, {
          headers: {
            Authorization: `Bearer ${this.i.accessToken}`,
          },
        })
      } catch (err) {
        if (_.hasIn(err, 'response')) {
          const res = err.response
          const debugObj = { status: res.status, headers: res.headers, data: res.data, to, messages }
          console.log(debugObj)
          err.stack = `${err.name}: LINE pushMessage failed with status code ${res.status}\n${JSON.stringify(debugObj, null, 2)}`
        }
        throw err
      }
    },
    isLineId (lineId) {
      return lineId !== 'Udeadbeefdeadbeefdeadbeefdeadbeef' && /^U[0-9a-f]{32}$/.test(lineId)
    },
  },
})</script></body></html>