<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"><title>微程式課程簽到簿</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3"></script><script>window.dataLayer = window.dataLayer || []
function gtag () { dataLayer.push(arguments) } // eslint-disable-line
gtag('js', new Date())
gtag('config', 'UA-39556213-3')</script><script>(function () {
  const hostname = location.host.split(':')[0]
  if (hostname === 'localhost') document.write(`<script src="http://${hostname}:35729/livereload.js?snipver=1"></` + 'script>')
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-default@3/default.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.min.css"><style>[v-cloak] {
  display: none; }

img.card-img {
  width: 100px; }
</style></head><body><div class="container text-monospace" id="app" v-cloak><h1 class="my-3 text-center">微程式課程簽到簿</h1><div class="my-3" id="not-signin" v-if="!user"><button class="btn btn-success btn-block" type="button" @click="btnSignin"><span class="fa fa-google"></span> 請用微程式 Google 帳戶登入</button></div><div class="card border-danger my-3" id="signin" v-else><div class="row no-gutters"><img class="card-img" :src="user.imageUrl"><div class="col"><div class="card-body"><h5 class="card-title">{{ user.name }} <small class="text-muted">{{ username }}</small></h5><p class="card-text">已累計課程點數 {{ totalScore }} 點</p></div></div></div></div><div class="card my-3" v-if="course"><img class="card-img-top" v-if="course.image" :src="course.image"><div class="card-body"><h5 class="card-title">{{ course.name }}</h5><h6 class="card-subtitle mb-2 text-muted" v-if="course.score &gt; 0">簽到將可累計課程點數 {{ course.score }} 點</h6><button class="btn btn-success mr-2" v-if="!user" type="button" @click="btnSignin"><span class="fa fa-google"></span> 請登入簽到</button><button class="btn btn-success mr-2" v-else-if="loading" type="button" disabled><span class="spinner-border spinner-border-sm" role="status"></span> 正在簽到中</button><button class="btn btn-success mr-2" v-else-if="isCheckIn" type="button" disabled>已簽到</button><button class="btn btn-success mr-2" v-else type="button" @click="btnCheckIn">課程簽到</button><a class="btn btn-outline-primary" type="button" :href="course.url" target="_blank">相關連結</a></div></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script><!-- bootstrap require jquery and pupper--><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="https://cdn.jsdelivr.net/npm/crypto-js@4/crypto-js.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js"></script><script>/* global gapi */
const LOCAL_STORAGE_KEY = 'microprogram-course'
const vm = new Vue({ // eslint-disable-line
  el: '#app',
  data: {
    attends: [],
    idToken: null,
    loading: false,
    user: null,
    i: {
      checkins: [],
    },
  },
  async mounted () {
    try {
      const saved = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY))
      if (saved) this.$set(this, 'i', { ...this.i, ...saved })
    } catch (err) {}
    this.$watch('i', (newVal, oldVal) => {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(this.i))
    }, { deep: true })
    await this.getAttends()
  },
  computed: {
    totalScore () {
      return _.sumBy(this.attends, a => a.id === this.user.id ? _.parseInt(a.score) : 0)
    },
    username () {
      if (!this.user) return ''
      return _.get(this.user.email.split('@'), '0', '')
    },
    c () {
      const url = new URL(location)
      return url.searchParams.get('c')
    },
    course () {
      try {
        return JSON.parse(this.btoa(this.c.split('.')[1]))
      } catch (err) {
        return null
      }
    },
    isCheckIn () {
      if (!this.course) return false
      return _.includes(this.i.checkins, this.course.nonce)
    },
  },
  methods: {
    async gapiOnInit () {
      // 初始化函式庫
      await new Promise(resolve => { gapi.load('client:auth2', resolve) })
      await gapi.client.init({
        clientId: '417954202747-62a0pn2ankrsco790jr1h29n9vnf92lm.apps.googleusercontent.com',
        scope: 'profile email',
      })
      // 等候使用者登入
      const auth2 = gapi.auth2.getAuthInstance()
      await new Promise(resolve => {
        const updateSigninStatus = isSignedIn => { if (isSignedIn) resolve() }
        auth2.isSignedIn.listen(updateSigninStatus)
        updateSigninStatus(auth2.isSignedIn.get())
      })
      // 登入成功
      const googleUser = auth2.currentUser.get()
      const profile = googleUser.getBasicProfile()
      this.$set(this, 'user', {
        email: profile.getEmail(),
        familyName: profile.getFamilyName(),
        givenName: profile.getGivenName(),
        id: profile.getId(),
        imageUrl: profile.getImageUrl(),
        name: profile.getName(),
      })
      this.idToken = googleUser.getAuthResponse().id_token
    },
    btnSignin () {
      gapi.auth2.getAuthInstance().signIn()
    },
    btoa (str) {
      str = str.replace(/[-_]/g, c => _.get({ '-': '+', _: '/' }, c, ''))
      return CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Base64.parse(str))
    },
    async btnCheckIn () {
      try {
        this.loading = true
        await axios.post('https://us-central1-ai-country.cloudfunctions.net/microprogram-course', {
          c: this.c,
          g: this.idToken,
        })
        this.saveCheckIns()
        this.attends.push({ // 新增一個假的課程紀錄，因為資料不會那麼快更新
          id: this.user.id,
          score: this.course.score,
        })
        Swal.fire({
          icon: 'success',
          title: '簽到成功',
          text: this.course.score > 0 ? `您已成功獲得 ${this.course.score} 點課程點數` : '感謝您參加課程',
        })
      } catch (err) {
        console.log(err)
        if (err.status !== 500) this.saveCheckIns()
        Swal.fire({
          icon: 'error',
          title: '簽到失敗',
          text: _.get(err, 'response.data.message') || err.message,
        })
      }
      this.loading = false
    },
    saveCheckIns () {
      const checkins = _.slice(_.uniq([...this.i.checkins, this.course.nonce]), -10)
      this.$set(this.i, 'checkins', checkins)
    },
    async getCsv (url) {
      const csv = _.trim(_.get(await axios.get(url, {
        params: { cachebust: new Date() / 3e4 },
      }), 'data'))
      return _.get(Papa.parse(csv, {
        encoding: 'utf8',
        header: true,
      }), 'data', [])
    },
    async getAttends () {
      this.attends = await this.getCsv('https://docs.google.com/spreadsheets/d/e/2PACX-1vTDyD-tW4bDQ-7NILOhpBPRrskDpQZvaQw9_my-Mbd8TJ7j_xRlBxSUdYtNSfeNhF-gzALuNHia8f36/pub?gid=1069299348&single=true&output=csv')
    },
  },
})</script><script src="https://apis.google.com/js/api.js" async defer onload="this.onload=function(){}; vm.gapiOnInit()" onreadystatechange="if (this.readyState === 'complete') this.onload()"></script></body></html>