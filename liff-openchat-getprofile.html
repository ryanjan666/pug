<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no"><title>在 Open Chat 執行 getProfile</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-39556213-3"></script><script>window.dataLayer = window.dataLayer || []
function gtag () { dataLayer.push(arguments) } // eslint-disable-line
gtag('js', new Date())
gtag('config', 'UA-39556213-3')</script><script>(function () {
  const hostname = location.host.split(':')[0]
  if (hostname === 'localhost') document.write(`<script src="http://${hostname}:35729/livereload.js?snipver=1"></` + 'script>')
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-default@3/default.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.min.css"><style>[v-cloak] {
  display: none; }
</style></head><body><div class="container my-4 text-monospace" id="app" v-cloak><div id="page-step1" v-if="page === 'step1'"><h1 class="my-3 text-center">Step 1</h1><p>請點選以下按鈕，讓程式可以順利呼叫 getProfile。</p><button class="btn btn-primary btn-block" type="button" @click="btnOpenExternal">getProfile</button></div><div id="page-step2" v-if="page === 'step2'"><h1 class="my-3 text-center">Step 2</h1><p>成功呼叫 getProfile，接下來請回到 Open Chat 中再次開啟 LIFF。</p><button class="btn btn-primary btn-block" type="button" @click="btnClose">關閉頁面</button></div><div id="page-step3" v-if="page === 'step3'"><h1 class="my-3 text-center">Step 3</h1><p>成功從 localStorage 中取得 profile。</p><button class="btn btn-danger btn-block" type="button" @click="btnClearProfile">清除 profile</button></div><div id="page-error" v-if="page === 'error'"><h1 class="my-3 text-center">發生錯誤</h1></div><div class="my-3" v-if="context"><h4>context</h4><pre class="language-json" v-html="prismjs(JSON.stringify(context, null, 2))"></pre></div><div class="my-3" v-if="profile"><h4>profile</h4><pre class="language-json" v-html="prismjs(JSON.stringify(profile, null, 2))"></pre></div><div class="my-3" v-if="error"><h4>error</h4><pre class="language-json" v-html="prismjs(JSON.stringify(error, null, 2))"></pre></div></div><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lodash@4/lodash.min.js"></script><script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1/dist/umd/popper.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://cdn.jsdelivr.net/npm/qs@6/dist/qs.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script><script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script><!-- bootstrap require jquery and pupper--><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-json.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vconsole/dist/vconsole.min.js"></script><script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script><script>/* global Prism */
const vConsole = new VConsole() // eslint-disable-line
const errorToJson = (() => {
  const ERROR_KEYS = [
    'address',
    'code',
    'data',
    'dest',
    'errno',
    'info',
    'message',
    'name',
    'originalError.response.data',
    'path',
    'port',
    'reason',
    'response.data',
    'response.headers',
    'response.status',
    'stack',
    'status',
    'statusCode',
    'statusMessage',
    'syscall',
  ]
  return err => _.transform(ERROR_KEYS, (json, k) => {
    if (_.hasIn(err, k)) _.set(json, k, _.get(err, k))
  }, {})
})()
const vm = new Vue({ // eslint-disable-line
  el: '#app',
  data: {
    context: null,
    error: '',
    page: '',
    profile: null,
  },
  async mounted () {
    try {
      await liff.init({ liffId: '1654046335-BWEQYWM1' })
      this.context = liff.getContext()

      if (_.get(this, 'context.type') === 'square_chat') {
        // 在 Open Chat 內開啟
        this.profile = this.getSavedProfile()
        this.page = this.profile ? 'step3' : 'step1'
      } else {
        // 在其他環境內開啟
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: location.href })
          return await new Promise(resolve => {}) // 永遠不會結束的 Promise
        }
        this.profile = await liff.getProfile()
        const cid = this.param('cid')
        if (!cid) throw new Error('cid is required.')
        localStorage.setItem(cid, JSON.stringify(this.profile))
        this.page = 'step2'
      }
    } catch (err) {
      this.handleError(err)
    }
  },
  methods: {
    getCid () {
      const sid = _.get(this, 'context.squareId')
      const mid = _.get(this, 'context.squareMemberId')
      if (!sid || !mid) throw new Error()
      return `${sid}-${mid}`
    },
    getSavedProfile () {
      try {
        const cid = this.getCid()
        const saved = localStorage.getItem(cid)
        return JSON.parse(saved)
      } catch (err) {
        return null
      }
    },
    param (key) {
      const url = new URL(location)
      return url.searchParams.get(key)
    },
    async btnOpenExternal () {
      try {
        const url = new URL('https://liff.line.me/1654046335-BWEQYWM1/')
        url.searchParams.set('cid', this.getCid())
        liff.openWindow({
          url: url.href,
          external: true,
        })
        return await new Promise(resolve => {}) // 永遠不會結束的 Promise
      } catch (err) {
        this.handleError(err)
      }
    },
    btnClose () {
      try {
        liff.closeWindow()
      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: '發生錯誤',
          text: '請手動關閉頁面',
        })
      }
    },
    btnClearProfile () {
      try {
        const cid = this.getCid()
        localStorage.removeItem(cid)
        this.btnClose()
      } catch (err) {
        this.handleError(err)
      }
    },
    handleError (err) {
      this.page = 'error'
      this.error = errorToJson(err)
      console.error(err)
      Swal.fire({
        icon: 'error',
        title: '發生錯誤',
        text: err.message,
      })
    },
    prismjs (code, language = 'json') {
      const dom = document.createElement('code')
      dom.textContent = code
      dom.className = `language-${language}`
      Prism.highlightElement(dom)
      return dom.outerHTML
    },
  },
})</script></body></html>